[TOC]

# 单片机的C语言

> 平时50% 期末50%



### 单片机基础知识 #1

##### 8051的内部结构

- 单片机组成④：CPU、存储器、内部资源、I/O

- CPU
  - 运算器：ALU、ACC、PSW：存放了CPU工作时的很多状态、暂存寄存器
  - 控制器：IR指令寄存器、ID指令译码器、PC程序计数器、定时控制与条件转移逻辑电路
    - 时钟：由一个反相放大器构成振荡器产生，可以是内部方式或外部方式
    - 基本时序周期：振荡周期、时钟周期（=2\*振荡周期）、机器周期（=6*时钟周期）、指令周期
    - 指令部件：计数器PC、指令寄存器IR、指令译码器ID、数据指针DPTR（16位地址寄存器）
- 存贮器组织
  - 8051采用程序存储器（ROM）和数据存储器（RAM）独立分开的哈佛结构
  - 四个存储器：片内程序、片内数据、片外程序、片外数据
  - 程序存储器片内外统一编址；数据存储器片内外不统一编址
  - 程序存储器
    - 片内有4k字节ROM，片外用16位地址线，最多可扩展64k字节ROM，两者统一编址
    - （0000H~0FFFH）EA非 保持高电平时，8051执行片内前4KB ROM地址中的程序；保持低电平时执行片外
    - （1000H~FFFFH）当寻址范围超过4KB时仅从片外存储器读取
  - 数据存储器
    - 片内RAM 128B，地址范围00H~7FH
    - 片外RAM 64KB，地址范围0000H~FFFFH
    - 片内分布：寄存器4组（通过RS1、RS0选择，容量共32B）、位地址区、通用RAM区
  - 特殊功能寄存器（21个字节）
    - 与ALU相关：ACC、暂存寄存器、PSW（存储包括进位标志CY、溢出OV、RS1、RS0等）
    - 与指针相关：SP堆栈指针、DPTR数据指针
    - 与端口相关⑦：P0~P3、SCON、SBUF、PCON
    - 与TC相关：TMOD、TCON、TH0等
    - 与中断相关：IP中断优先、IE中断允许
- I/O端口
  - 有4个8位I/O接口P0-3，每个端口都是8位准双向口，共占32根引脚（可用Px.x方式表达）
  - 每个端口包括④：锁存器、输入缓冲器、输出驱动器、端口引脚
    - 无片外扩展时，这4个端口的每一位都可以作为准双向通用I/O端口使用
    - 有片外扩展时，P2口作为高8位地址线，P0口作为低8位地址线和双向数据总线
    - P0为双向三态口（高电平、低电平、高阻），P3有第二功能
- 8051的内部资源
  - 串行口：可编程的、全双工的串行接口
    - 串行收发存贮在SFR中的串行数据缓冲器SBUF中的数据
    - 机器内部有两个数据缓冲器：发送/接收，可以同时收发
  - 定时器/计数器
    - 两个定时器/计数器T0、T1
    - 控制功能由定时器方式控制寄存器TMOD来完成
    - 定时器计到规定数值时可以向CPU发出中断申请。由定时器控制寄存器TCON完成
    - 计时工作时，时钟由单片机内部提供，时钟脉冲由T0、T1输入
  - 中断系统
    - 8051的中断系统允许5个独立的中断源：2个外部、2个定时器计数器、1个串行
    - 外部中断申请通过’INT0和‘INT1输入

```
8051的芯片引脚

- Vcc、Vss：接5v电源、接地
- XTAL1、XTAL2：使用内部振荡电路时，用来接石英晶体和电容；使用外部振荡电路时，用来输入时钟脉冲
- P0：双向IO口
- P1-2：准双向口
- P3：多用途端口
- ALE/'PROG'：地址锁存信号输出端。在访问片外存贮器时，ALE为有效高电平时，P0口输出地址低8位，可以用ALE信号做外部地址锁存器的锁存信号。'PROG'是对8751的EPROM编程时的编程脉冲输入端
- RST/V~PD~：复位信号输入端、备用电源输入端
- 'EA'/V~PP~：内部和外部程序存贮器选择线。'EA'=0时选择在外部ROM的程序
- 'PSEN'：片外程序存贮器选通信号
```

##### 工作方式

- 复位方式
  - 复位是单片的初始状态，持续时间不少于24个振荡周期时时复位
  - 在RST引脚上加上高电平可以实现复位
  - 复位后各寄存器状态
    - PC：0000H（程序入口）
    - 并行口P0~P3：0FFH（可以直接输入）
    - SP：07H（栈底已经设好）
    - PSW：00H（选择0组寄存器）

##### 系统扩展

- 程序存储器的扩展
  - 扩展电路连接：可使用EPROM2764扩展

##### 指令系统

- 寻址就是根据指令中给出的地址寻找真实操作数地址的方式
- 寻址方式：寄存器寻址、直接寻址（内部RAM以及SFR）、寄存器间接寻址、立即寻址、变址寻址、相对寻址、位寻址
- 指令
- 伪指令

[TOC]

### C51 #2

##### SFR与sbit

- 8051有21个SFR，只能通过直接寻址方式访问。8051中，除了计数器PC和4组通用寄存器外，其他所有的寄存器均称为SFR

  - 仅适用于8051系列的直接访问方法

    `sfr sfr_name = int location`

  - 定义中的等号并非是赋值语句，而是SFR地址
  
  - 高字节必须位于低字节之后。这种定义适用于所有SFR，除定时/计数器
  
- 特殊功能寄存器可寻址位的定义：使用sbit

##### 存储类型

- 存储类型的声明，指示了编译系统给变量分配的物理存储空间类别和寻址方式区别
  - 片内数据存储器：data, bdata, idata
  - 片外数据存储器：pdata, xdata
  - 程序存储器：code
- static
  - 在本模块定义的全局变量或函数，若不希望能被其他模块使用，则用static声明该标识符为静态的，不能通过extern扩展到其他模块
  - 定义变量时，意味着该变量是静态的（全局变量）



[TOC]

### 8051内部资源的C编程 #8

##### 中断

- 中断允许软件不需要关心系统其他部分的定时要求

- 中断源⑤：任何引起计算机中断的事件
  - INT0、INT1：外部中断0、1。有电平方式和脉冲方式
  
  - T0、T1溢出中断
  
  - 串行口中断RT/TI
  
  - 优先级、编号（先》后、0-4）
    - 外部中断0 - TC0 - 外部中断1 - TC1 - 串行口中断
    
    ```c
    void 函数名() interrupt n
    // n为编号
    ```
  
- 中断寄存器④：TCON、SCON、IE中断允许控制寄存器、IP中断优先级控制寄存器

  - TCON 定时控制寄存器

    | TF1  |      | TF0  |      | IE1  | IT1  | IE0  | IT0  |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | :--: |

    - IT 外部中断0，1触发*方式选择* 位（电平触发或下降沿触发）
    - IE 外部中断0，1**请求**标志位
    - TF TC0，1溢出中断**请求**标志
    - CPU响应中断时由硬件对应清零（IE/TF = 0）

  - SCON 串行口控制寄存器
    
    |      |      |      |      |      |      |  TI  |  RI  |
    | ---- | ---- | ---- | ---- | ---- | ---- | :--: | :--: |
    
    - RI，TI分别为 串行口接收、发送中断请求标志位
    - 当串行口接受/发送完一帧数据后请求中断，由硬件置1。必须由软件清零

  - IE 中断允许寄存器

    | EA   |      | ET2  | ES   | ET1  | EX1  | ET0  | EX0  |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |

    - EA CPU开关中断控制位
    - EX 外部中断0、1的中断允许位
    - ET TC溢出中断允许位
    - ES 串行口中断允许

  - IP 中断优先级寄存器

    |      |      |      | PS   | PT1  | PX1  | PT0  | PX0  |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
    
  - 优先级分 1高优先级、0低优先级。先优先级再默认优先级
    
  - 一个正在执行的中断服务*只能被* 较高级的中断请求中断
    
  - 8051复位时，IP被清0

- 中断响应

  - 执行中断条件（下一机器周期）
    - CPU未在处理同级或更高级的中断
    - 当前指令周期结束
    - 正在执行的不是RETI、RET或是访问IE、IP的指令
  - 中断响应后CPU将执行
    - 硬件清除中断请求标志（中断口）
    - 执行一条硬件子程序，保护断点，并转向中断服务程序入口
    - 执行RETI指令，恢复断点，返回主程序
  - 中断响应时间：3-8个周期
  - 中断返回：最后一条指令是RETI，使得CPU返回断电处

##### 定时器、计数器（T/C）

- 8051的TC是+1计数的，每个机器周期计数值+1

  ```
  若fosc = 6MHz，一个机器周期为 12/fosc = 2μs
  ```

- 与TC有关的SFR

  - 计数寄存器TH、TL（1、0）

  - TCON 定时器控制寄存器
    | TF1  | TR1  | TF0  | TR0  | IE1  | IT1  | IE0  | IT0  |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | :--: |
    
    - TF、IE 中断请求标志
    - TR 启动计时器
    - IT 触发方式选择：0低电平，1下降沿
    
  - TMOD 工作方式控制寄存器

    - 计数器或定时器选择位 C/'T，工作方式选择位M1,M0，GATE 门控信号（是否接收门控信号控制）
    - 前4位由T1控制，后4位由T0控制

  | GATE | C/'T' | M1   | M0   | GATE | C/'T' | M1   |  M0  |
  | ---- | ----- | ---- | ---- | ---- | ----- | ---- | :--: |

- TC工作方式

  - M1M0 = 00 13位TC，TL仅提供5位，满计数值为2^13^
  - M1M0 = 01 16位TC，满计数值为2^16^
    - 方式0、1在计数满后，需用软件向TH、TL重装预置计数初值
    - TH、TL可置负数
  - M1M0 = 10  8位TC，TL计数，TH寄存8位初值，计满自动重装载
  - M1M0 = 11 只适合TC0，TH0和TL0为两个独立TC
  
- 初始化

  TMOD》计算TH、TL》开启中断》启动viaTCON

##### 串行口

- 串行与并行

  - 并行通信方式占用传输线多，速度快，串行通反之
  - 8051系列单片机有UART（通用异步接收、发送）
    - TXD发送、RXD接收、两个缓冲器SBUF
    - 在TC1中设置产生波特率的TC1

- 与串口有关SFR

  - SCON 串行口控制寄存器

    | SM0  | SM1  | SM2  | REN  | TB8  | RB8  | TI   | RI   |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |

    - SM0、SM1 串行口工作方式控制位
    - REN 接收允许位，1表示允许
    - TI、RI 中断标志。在中断中必须用软件将此清零

    ```c
    SCON = 0x50;
    // 即 0101 0000，SM1和REN=1，即工作方式1
    ```

  - 电源控制寄存器PCON

    | SMOD |      |      |      | GF1  | GF0  | PD   | IDL  |
    | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |

- 串行口工作方式

  - 方式0 收发数据为8位，低位在前。波特率为fosc/12
  - 方式1 收发数据为8位+起始位（0）和停止位（1）共10位。波特率由定时器控制，波特率 = 2^SMOD^ * TC1的溢出率 / 32
  - 方式2、3 收发数据11位




[TOC]

### 8051的输出控制C编程 #12

##### D/A转换

- D/A转换（Digital to Analog）性能指标
  - 分辨率、绝对精度和相对精度、线性度、建立时间

##### 步进电机

- 步进电机直接接收数字脉冲，使电机旋转过相应的角度
  - 优点：快速启停、精准定位
  - 特点：给脉冲就转，脉冲频率越高越快，改变各相的通电顺序可以控制正反转

[TOC]

## 实验：单片机编程

#### 亮灯#1

- 三极管截止

  - 三种状态：截止、放大、饱和。单片机中通常只用到截止和饱和两种状态
  - 口诀：箭头朝内 PNP，导通电压顺箭头过，电压导通，电流控制。箭头始端比末端高于0.7v以上

  <img src="C:\Users\Airy\AppData\Roaming\Typora\typora-user-images\image-20210426173633871.png" alt="image-20210426173633871" style="zoom:50%;" />c↓     e↑     b

  - 如果给LEDS6一个高电平1，b和e都是5v，不亮
  - 如果给LEDS6一个低电平0，产生压差，有(5-0.7)V 的电压会在电阻 R47 上，可以点亮LED2

- 三极管饱和

  - 要想处于饱和状态，b 极电 流就必须大于 e 和 c 之间电流值除以放大倍数β

- 三极管应用

  - 常用于控制、驱动

- 单片机的 IO 口数量是有限的，为了控制更多的器件，就要使用一些外围的数字芯片，如C51的74HC138 这个三八译码器
  - 三八译码器：把三种输入状态翻译成8种输出状态
  - ADDR0\~ADDR2对应着A0~A2，ENLED、ADDR3对应着使能端的三个脚，为了使译码器正常工作，ENLED=0，ADDR3=1
  - 代码中的组合使得只有Y6输出一个低电平，可以开通三极管Q16，5V电源加到了LED上
  - 让引脚P0.0=0，即DB_0 等于 0（74HC245），因此只有LED2和5v之间有压差，使得有电流通过，灯亮

#### 定时器 #2

- 定时器由特殊功能寄存器SFR控制
  - 计数寄存器TH、TL
  - 定时器/计数器控制寄存器TCON
  - T/C的方式控制寄存器TMOD

#### 中断 #3

- 设置中断，当单片机正在处理其他代码时遇到了中断，需要先处理中断的任务，然后继续回去处理原来的代码

- 使用中断

  - EA=1 中断总开关》开

  - ET0 = 1 计时器T0中断开关》开
  
  - ```
    void InterruptTimer0() interrupt 1
    ```

  - 常用：

    - interrupt 1 选择了定时器0的中断使能
    - interrupt 4 串口中断使能

#### 按键 #4

- 复位电路
- 按键消抖：当检测到按键状态变化时，不是立即去响应动作，而是先等待闭合或断开稳定后再 进行处理。按键消抖可分为硬件消抖和软件消抖。这里只介绍软件消抖
  - 延时10ms后再判断。但延时过程中就不能处理其他代码了
  - 每 2ms 进一次中断，扫描一次按 键状态并且存储起来，连续扫描 8 次后，看看这连续 8 次的按键状态是否是一致的

#### LCD显示（1602液晶） #5

- 1602：每行16个字符，共两行
  - 左上角的坐标是(0，0)
- 引脚
  - VSS、VDD 电源地、电源正极
  - VL 液晶显示偏压信号。用于调整显示的黑点和不显示的之间的对比度
  - RS 数据/命令选择端
  - R/W 读/写选择端
  - E 使能信号
  - D0-D7
- 1602读写时序
- 1602液晶的指令
  - 显示模式设置
  - 显示开关以及光标设置指令
  - 清屏指令
  - RAM地址设置指令

#### 综合编程 #6



















